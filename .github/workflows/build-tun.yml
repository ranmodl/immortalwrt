name: Build Redmi AX3000 with TUN (Manual Config Fix)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 300
    env:
      CACHE_DIR: "/home/runner/.cache/immortalwrt"
      # å®˜æ–¹IPQ50xxé…ç½®æ–‡ä»¶çš„URLï¼ˆä»ImmortalWrtå®˜æ–¹ä»“åº“è·å–ï¼‰
      IPQ50XX_CONFIG_URL: "https://raw.githubusercontent.com/immortalwrt/immortalwrt/main/target/linux/qualcommax/ipq50xx/image/Makefile"
      TARGET_PATH: "target/linux/qualcommax/ipq50xx/image"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 1

      - name: Free up disk space
        run: |
          sudo apt-get autoremove -y && sudo apt-get clean -y
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo rm -rf /var/lib/apt/lists/* /var/cache/apt/*
          mkdir -p $CACHE_DIR && ln -s $CACHE_DIR dl

      - name: ğŸ”§ æ‰‹åŠ¨ä¸‹è½½IPQ50xxé…ç½®æ–‡ä»¶ï¼ˆå…³é”®ä¿®å¤ï¼‰
        run: |
          # åˆ›å»ºç›®æ ‡ç›®å½•ï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰
          mkdir -p $TARGET_PATH
          
          # ä»å®˜æ–¹ä»“åº“ä¸‹è½½ç¼ºå¤±çš„Makefile
          echo "ä»å®˜æ–¹ä»“åº“ä¸‹è½½IPQ50xxé…ç½®æ–‡ä»¶..."
          wget -O "$TARGET_PATH/Makefile" $IPQ50XX_CONFIG_URL
          
          # éªŒè¯æ–‡ä»¶æ˜¯å¦ä¸‹è½½æˆåŠŸ
          if [ ! -f "$TARGET_PATH/Makefile" ]; then
            echo "ERROR: ä¸‹è½½é…ç½®æ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥URLæ˜¯å¦æœ‰æ•ˆï¼"
            exit 1
          else
            echo "âœ… æˆåŠŸè¡¥å……IPQ50xxé•œåƒé…ç½®æ–‡ä»¶"
            # æ˜¾ç¤ºæ–‡ä»¶å†…å®¹å‰å‡ è¡Œï¼Œç¡®è®¤æ­£ç¡®
            head -n 5 "$TARGET_PATH/Makefile"
          fi

      - name: Initialize environment
        run: |
          sudo bash -c 'bash <(curl -s https://build-scripts.immortalwrt.org/init_build_environment.sh)'
          ./scripts/feeds update -a -q && ./scripts/feeds install -a -q

      - name: Configure firmware (Enable TUN)
        run: |
          make defconfig
          # å¯ç”¨TUNæ”¯æŒ
          echo "CONFIG_KERNEL_TUN=y" >> .config
          echo "CONFIG_KERNEL_TUN_VNET_CROSS_LE=y" >> .config
          echo "CONFIG_PACKAGE_kmod-tun=y" >> .config
          # ç¦ç”¨å†—ä½™åŠŸèƒ½
          echo "# CONFIG_PACKAGE_luci is not set" >> .config
          make defconfig

      - name: Compile core components
        run: |
          make -j$(nproc) 2>&1 | tee -a compile-error.log

      - name: Generate firmware (with debug log)
        run: |
          make image -j1 V=s 2>&1 | tee image-build.log

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: redmi-ax3000-firmware
          path: |
            bin/targets/qualcommax/ipq50xx/*.bin
            bin/targets/qualcommax/ipq50xx/*.ubi
            compile-error.log
            image-build.log
          retention-days: 30
